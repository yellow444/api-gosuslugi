import json
import re
from requests.exceptions import RequestException, Timeout, ConnectionError

"""
üìå –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ –ï–°–ò–ê, –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–æ–≥–ª–∞—Å–∏–π –∏ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.

üîπ –°–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:
   - "–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ï–°–ò–ê" (—Ä–∞–∑–¥–µ–ª 5.2.20, 5.2.25)&#8203;:contentReference[oaicite:0]{index=0}
   - "–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å REST API –¶–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è" (—Ç–∞–±–ª–∏—Ü–∞ 23, 42, 44)&#8203;:contentReference[oaicite:1]{index=1}

üìÑ –ï–°–ò–ê –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `"error"`, `"error_description"`.  
üìÑ –¶–∏—Ñ—Ä–æ–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–µ `"errorCode"`.  
üìÑ –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å–æ–≥–ª–∞—Å–∏–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `permissions` –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –¥–æ—Å—Ç—É–ø–∞.
"""

# === 1. –û—à–∏–±–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ) ===
class EsiaError(Exception):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –æ—à–∏–±–æ–∫ –ï–°–ò–ê."""
    def __init__(self, error_code, message):
        self.error_code = error_code
        self.message = message
        super().__init__(f"[{error_code}] {message}")

class EsiaAuthError(EsiaError):
    """–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –ï–°–ò–ê"""

class EsiaTokenError(EsiaError):
    """–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –ï–°–ò–ê"""

class EsiaAPIError(EsiaError):
    """–û—à–∏–±–∫–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API –ï–°–ò–ê"""

class EsiaNetworkError(EsiaError):
    """–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ï–°–ò–ê"""

class DigitalProfileError(Exception):
    """–û—à–∏–±–∫–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è"""

class NetworkError(Exception):
    """–û—à–∏–±–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è"""

# === 2. –û—à–∏–±–∫–∏ –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è (–¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –ï–°–ò–ê) ===
ESIA_ERRORS = {
    # –û—à–∏–±–∫–∏ OAuth2
    "ESIA-007002": "–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –∏ –º–Ω–µ–º–æ–Ω–∏–∫–∏",
    "ESIA-007003": "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä",
    "ESIA-007004": "–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ä–µ—Å—É—Ä—Å–∞",
    "ESIA-007005": "–°–∏—Å—Ç–µ–º–∞-–∫–ª–∏–µ–Ω—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞",
    "ESIA-007006": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π scope",
    "ESIA-007007": "–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ –ï–°–ò–ê",
    "ESIA-007008": "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
    "ESIA-007009": "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞",
    "ESIA-007011": "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω",
    "ESIA-007012": "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø grant",
    "ESIA-007013": "–ù–µ —É–∫–∞–∑–∞–Ω scope",
    "ESIA-007014": "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä",
    "ESIA-007015": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞",
    "ESIA-007019": "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø",
    "ESIA-007046": "–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è",
    "ESIA-007053": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π client_secret",
    "ESIA-007055": "–í—Ö–æ–¥ —Å –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–π —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é",
    "ESIA-008010": "–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã-–∫–ª–∏–µ–Ω—Ç–∞",
}

# === 3. –û—à–∏–±–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–æ–≥–ª–∞—Å–∏–π (permissions) ===
PERMISSIONS_ERRORS = {
    "ESIA-036700": "–ù–µ —É–∫–∞–∑–∞–Ω–∞ –º–Ω–µ–º–æ–Ω–∏–∫–∞ —Ç–∏–ø–∞ —Å–æ–≥–ª–∞—Å–∏—è",
    "ESIA-036701": "–ù–µ –Ω–∞–π–¥–µ–Ω —Ç–∏–ø —Å–æ–≥–ª–∞—Å–∏—è",
    "ESIA-036702": "–ù–µ —É–∫–∞–∑–∞–Ω –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π scope",
    "ESIA-036703": "–°–∫–æ—É–ø—ã –≤—ã—Ö–æ–¥—è—Ç –∑–∞ —Ä–∞–º–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö",
    "ESIA-036704": "–ó–∞–ø—Ä–µ—â–µ–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Å–∫–æ—É–ø—ã",
    "ESIA-036705": "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ",
    "ESIA-036706": "–£–∫–∞–∑–∞–Ω–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
    "ESIA-036707": "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–µ–ª—å",
    "ESIA-036716": "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—Ä–µ–º—è –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å—Ä–æ–∫–∞ —Å–æ–≥–ª–∞—Å–∏—è",
}

# === 4. –§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ ===
def parse_error(response_text: str):
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∫–æ–¥ –æ—à–∏–±–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ï–°–ò–ê –∏–ª–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã —Å–æ–≥–ª–∞—Å–∏–π.

    üìÑ –°–æ–≥–ª–∞—Å–Ω–æ "–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ï–°–ò–ê" (—Ä–∞–∑–¥–µ–ª 5.2.20)&#8203;:contentReference[oaicite:0]{index=0}

    :param response_text: JSON-–æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
    :return: —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏
    """
    try:
        response = json.loads(response_text)

        if "error" in response:
            error_code = response["error"]
            return EsiaAPIError(error_code, ESIA_ERRORS.get(error_code, f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ï–°–ò–ê: {error_code}"))

        if "errorCode" in response and response["errorCode"] in PERMISSIONS_ERRORS:
            return DigitalProfileError(PERMISSIONS_ERRORS[response["errorCode"]])

    except json.JSONDecodeError:
        raise EsiaAPIError("JSONDecodeError", "–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON.")


# === 5. –•–µ–Ω–¥–ª–µ—Ä –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—à–∏–±–æ–∫ –∏–∑ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ===
def parse_callback_error(query: dict):
    """
    –ü–∞—Ä—Å–∏–Ω–≥ –æ—à–∏–±–æ–∫ –ï–°–ò–ê –∏–∑ callback-–∑–∞–ø—Ä–æ—Å–æ–≤.

    üìÑ –°–æ–≥–ª–∞—Å–Ω–æ "–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ï–°–ò–ê" (—Ä–∞–∑–¥–µ–ª 5.2.25)&#8203;:contentReference[oaicite:3]{index=3}

    :param query: –°–ª–æ–≤–∞—Ä—å —Å query-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    :return: –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–æ–π –æ—à–∏–±–∫–∏
    """
    error_desc = query.get("error_description", "")
    match = re.search(r"ESIA-\d{6}", error_desc)
    error_code = match.group(0) if match else "UNKNOWN"
    return EsiaAPIError(error_code, ESIA_ERRORS.get(error_code, f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ï–°–ò–ê: {error_code}"))

# === 6. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ HTTP-–æ—à–∏–±–æ–∫ ===
def handle_http_errors(response):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ï–°–ò–ê."""
    if response.status_code == 400:
        raise EsiaAPIError("400", f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å - {response.text}")
    elif response.status_code == 401:
        raise EsiaAuthError("401", f"–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ - {response.text}")
    elif response.status_code == 403:
        raise EsiaAuthError("403", f"–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω - {response.text}")
    elif response.status_code == 500:
        raise EsiaAPIError("500", f"–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ï–°–ò–ê - {response.text}")
    else:
        response.raise_for_status()

# === 7. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫ ===
def handle_network_errors(func):
    """
    –î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ç–µ–≤—ã—Ö –æ—à–∏–±–æ–∫.

    üìÑ –°–æ–≥–ª–∞—Å–Ω–æ "–ú–µ—Ç–æ–¥–∏—á–µ—Å–∫–∏–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –ï–°–ò–ê" (—Ä–∞–∑–¥–µ–ª 5.2.20)&#8203;:contentReference[oaicite:4]{index=4}

    :param func: –§—É–Ω–∫—Ü–∏—è, –≤—ã–ø–æ–ª–Ω—è—é—â–∞—è —Å–µ—Ç–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å
    :return: –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ NetworkError
    """
    def wrapper(*args, **kwargs):
        try:
            return func(*args, **kwargs)
        except Timeout:
            raise NetworkError("–û—à–∏–±–∫–∞: –ø—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞")
        except ConnectionError:
            raise NetworkError("–û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –ï–°–ò–ê –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        except RequestException as e:
            raise NetworkError(f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {str(e)}")
    return wrapper
