### Полный процесс работы в тестовом контуре с услугой "Предоставление информации о наличии исполнительного производства онлайн"

| Тестовая среда Адрес |
| :- |
| [ЕСИА](https://esia-portal1.test.gosuslugi.ru/) |
| [ЕПГУ](https://svcdev-beta.test.gosuslugi.ru/) |
| [Технологический портал ЕПГУ](https://svcdev-partners.test.gosuslugi.ru/) |
| [Технологический портал ЕСИА](https://esia-portal1.test.gosuslugi.ru/console/tech/) |

## **1. Регистрация физических лиц в ЕСИА**

1. **Создание учетной записи физического лица**
   - Регистрация в [тестовой среде ЕСИА](https://esia-portal1.test.gosuslugi.ru/registration/).
   - Ввести личные данные:
     - ФИО
     - Паспорт
     - СНИЛС (должен быть реальным для корректной работы некоторых сервисов)
     - Email (реальный, потребуется для получения сертификатов и общения с Оператором)
     - Номер телефона (реальный)

2. **Подтверждение учетной записи**
   - Подтверждение учетной записи можно выполнить через центр госуслуг или почту.
   - Дождаться валидации данных в тестовой среде.
   - Мониторинг [кода подтверждения](https://esia-portal1.test.gosuslugi.ru/logs/postcodes/).

---

## **2. Регистрация организации в ЕСИА**

1. **Подача заявки на регистрацию организации**
   - Вход в [тестовую среду ЕСИА](https://esia-portal1.test.gosuslugi.ru/).
   - Использовать сертификат электронной подписи (КЭП) генерального директора.
   - Указать ОГРН, ИНН, наименование организации.
   - Заполнить заявку и направить её в ЕСИА.

2. **Подключение учетных записей сотрудников**
   - Сотрудники сначала создают подтверждённую учетную запись.
   - Генеральный директор добавляет сотрудников и назначает им полномочия.
   - Выдается доверенность на ответственного работника для формирования идентификационных ключей.

---

## **3. Получение Тестового Сертификата**

1. **Запрос сертификата**
   - Отправка заявки на [sd@sc.digital.gov.ru](mailto:sd@sc.digital.gov.ru) с заполненной формой.
   - Проверка соответствия сертификатов требованиям API.

2. **Ответ сервиса**
   - Получение PIN-кода `1234567890`.
   - Получение архива с сертификатом и контейнером закрытого ключа.
   - Инструкция по установке.

---

## **4. Регистрация информационной системы (ИС)**

1. **Создание ИС**
   - Создание системы в [Технологическом портале ЕСИА](https://esia-portal1.test.gosuslugi.ru/console/tech).
   - Указание мнемоники тестовой ИС.
   - Загрузка сертификата.

2. **Заявка на регистрацию ИС**
   - Отправка заявки на [sd@sc.digital.gov.ru](mailto:sd@sc.digital.gov.ru).
   - Использование email в домене организации.

---

## **5. Получение тестового API-ключа**

1. **Запрос API-ключа**
   - Добавить сотрудника с полномочиями.
   - Подать заявку в разделе [Мои системы](https://svcdev-partners.test.gosuslugi.ru/systems).
   - Скачать csv с ключем

---

## **6. Настройка взаимодействия с API Госуслуг**

1. **Зависимости проекта**
   1. Убедитесь, что установлены Docker, Docker Compose, Git.
   2. Клонируйте репозиторий проекта

2. **Настройки проекта**

   1. Настройте .env файлы для backend и frontend.
   2. Скопируйьте контейнер полученый от Оператора в папку `xxx.000`

3. **Прверка**
   1. Запустите контейнеры
   2. Проверте работу КриптоПро

---

## **7. Работа с заявками на предоставление услуги**

1. **Формирование XML-запроса**
   - Для формирования запроса подготовте необходимы файлы
   - Можно использовать редактор xml - там будет готовый пример
   - Наименования файлов и их типы могут регулироваться в каждой конкретной услеги. Но обычно это `req.xml` и `piev_epgu.xml` и `piev_epgu.xml`
   - Сам запрос архив либо  

2. **Отправка запроса**
   - После успешного подключения и авторизации по API-кллючу, получаем и сохраням токен доступа.
   - Затем если наш запрос меньше 50 000 000 байт и это не противоречит спецификации конкретной услуги, то запрос можно отправлять на `POST /api/gusmev/order`, в случае успешного ответа получаем и сохраняем `orderId`
   - Если запрос большого размера или есть указание в спецификации услуги, то для начала, создаем запрос `POST /api/gusmev/push/chunked` на получения  `orderId`. А затем, если потребуеться, внесем `orderId` в файлы запроса.   отправляем afq
   - Под капотом происходит обращение к `POST /api/gusmev/push/chunked`.
   - Подпись XML-документа через КриптоПро перед отправкой.
   - Получение номера заявки.

---

## **8. Обработка ответов**

1. **Получение статуса заявления**
   - `POST /api/gusmev/order/{orderId}`.
   - Отображение статуса в интерфейсе.

2. **Загрузка ответа ведомства**
   - `GET /download_file/{objectId}/{objectType}`.
   - Кнопка скачивания файла ответа.

3. **Обработка ошибок**
   - Проверка логов и отправка отчетов в техподдержку.

---

## **9. Интеграция с фронтендом**

1. **Разработка интерфейса**
   - Форма для подачи заявления с drag-and-drop загрузкой файлов.
   - Отображение статуса запроса в реальном времени.

2. **Интеграция с бэкендом**
   - Взаимодействие с FastAPI для запросов к API Госуслуг.
   - Обработка JWT-токенов.

3. **Загрузка и подписание документов**
   - Интеграция с КриптоПро для подписания документов.
   - Автоматизация отправки XML-запросов через API.

---

## **10. Выход в продуктивную среду**

1. **Тестирование взаимодействия с API**
   - Совместное тестирование с Оператором.
   - Автоматическое логирование и мониторинг API-запросов.

2. **Настройка продуктивной среды**
   - Оформление заявки на подключение.
   - Настройка API-ключей и OAuth 2.0.

3. **Запуск в эксплуатацию**
   - Мониторинг API-запросов и работа в продуктивной среде.
